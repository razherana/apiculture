{% extends "base_commerce.html" %}
{% load static %}
{% block title %}Fiche vente{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'commerce/css/form.css' %}">
<div class="form-card" id="vente-card">
    <h2>Fiche vente</h2>
    <button type="button" class="action-btn edit" id="edit-btn">Modifier</button>
    <button type="button" class="action-btn view" id="cancel-btn" style="display:none;">Annuler</button>
    <form id="vente-form">
        <div class="form-group">
            <label for="miel">Miel</label>
            <input type="text" id="miel_input" name="miel" value="{{ vente.miel }}" readonly>
            <select id="miel_select" name="miel" style="display:none;">
                {% for miel in miels %}
                    <option value="{{ miel.nom }}" {% if miel.nom == vente.miel %}selected{% endif %}>{{ miel.nom }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="client">Client</label>
            <input type="text" id="client_input" name="client" value="{{ vente.client }}" readonly>
            <select id="client_select" name="client" style="display:none;">
                {% for cl in clients %}
                    <option value="{{ cl.nom }}" {% if cl.nom == vente.client %}selected{% endif %}>{{ cl.nom }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="mode_payement">Mode de paiement</label>
            <input type="text" id="mode_payement_input" name="mode_payement" value="{{ vente.mode_payement }}" readonly>
            <select id="mode_payement_select" name="mode_payement" style="display:none;">
                {% for mp in modes_payement %}
                    <option value="{{ mp.mode }}" {% if mp.mode == vente.mode_payement %}selected{% endif %}>{{ mp.mode }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="quantite">Quantité (kg)</label>
            <input type="number" id="quantite" name="quantite" min="0" value="{{ vente.quantite }}" readonly>
        </div>
        <div class="form-group">
            <label for="montant">Montant (€)</label>
            <input type="number" id="montant" name="montant" min="0" step="0.01" value="{{ vente.montant }}" readonly>
        </div>
        <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" value="{{ vente.date }}" readonly>
        </div>
        <div class="form-group">
            <label for="note">Note</label>
            <input type="text" id="note" name="note" value="{{ vente.note }}" readonly>
        </div>
        <div style="display: flex; gap: 0.5em;">
            <button type="button" class="action-btn delete" id="delete-btn">Supprimer</button>
            <button type="submit" class="action-btn add" id="save-btn" style="display:none;">Enregistrer</button>
        </div>
    </form>
</div>

<script>
    // Mode switching logic
    const form = document.getElementById('vente-form');
    const editBtn = document.getElementById('edit-btn');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    // Fields except selects, handled below
    const simpleFields = Array.from(form.elements).filter(
        el => el.tagName === 'INPUT' && !['miel','client','mode_payement'].includes(el.name)
    );
    // Select & Input pairs
    const mielInput = document.getElementById('miel_input');
    const mielSelect = document.getElementById('miel_select');
    const clientInput = document.getElementById('client_input');
    const clientSelect = document.getElementById('client_select');
    const modePayementInput = document.getElementById('mode_payement_input');
    const modePayementSelect = document.getElementById('mode_payement_select');

    let originalValues = {};

    function setReadOnly(isReadOnly) {
        simpleFields.forEach(el => el.readOnly = isReadOnly);
        // Miel
        mielInput.style.display = isReadOnly ? '' : 'none';
        mielSelect.style.display = isReadOnly ? 'none' : '';
        // Client
        clientInput.style.display = isReadOnly ? '' : 'none';
        clientSelect.style.display = isReadOnly ? 'none' : '';
        // Mode paiement
        modePayementInput.style.display = isReadOnly ? '' : 'none';
        modePayementSelect.style.display = isReadOnly ? 'none' : '';
    }

    editBtn.addEventListener('click', function() {
        // Store original values for cancel (including selects)
        simpleFields.forEach(el => originalValues[el.name] = el.value);
        originalValues['miel'] = mielSelect.value;
        originalValues['client'] = clientSelect.value;
        originalValues['mode_payement'] = modePayementSelect.value;
        setReadOnly(false);
        editBtn.style.display = 'none';
        saveBtn.style.display = '';
        cancelBtn.style.display = '';
    });

    cancelBtn.addEventListener('click', function() {
        // Restore original values
        simpleFields.forEach(el => {
            if (originalValues[el.name] !== undefined) {
                el.value = originalValues[el.name];
            }
        });
        mielSelect.value = originalValues['miel'];
        clientSelect.value = originalValues['client'];
        modePayementSelect.value = originalValues['mode_payement'];
        mielInput.value = mielSelect.options[mielSelect.selectedIndex].text;
        clientInput.value = clientSelect.options[clientSelect.selectedIndex].text;
        modePayementInput.value = modePayementSelect.options[modePayementSelect.selectedIndex].text;
        setReadOnly(true);
        editBtn.style.display = '';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
    });

    // On select change, update input value (for real-time display if needed)
    mielSelect.addEventListener('change', function() {
        mielInput.value = mielSelect.options[mielSelect.selectedIndex].text;
    });
    clientSelect.addEventListener('change', function() {
        clientInput.value = clientSelect.options[clientSelect.selectedIndex].text;
    });
    modePayementSelect.addEventListener('change', function() {
        modePayementInput.value = modePayementSelect.options[modePayementSelect.selectedIndex].text;
    });

    // By default: view mode
    setReadOnly(true);

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        // On save, update input fields with selected values
        mielInput.value = mielSelect.options[mielSelect.selectedIndex].text;
        clientInput.value = clientSelect.options[clientSelect.selectedIndex].text;
        modePayementInput.value = modePayementSelect.options[modePayementSelect.selectedIndex].text;
        setReadOnly(true);
        editBtn.style.display = '';
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        alert("Modifications enregistrées (simulation)");
    });

    document.getElementById('delete-btn').addEventListener('click', function() {
        if(confirm("Voulez-vous vraiment supprimer cette vente ?")) {
            alert("Vente supprimée (simulation)");
        }
    });
</script>
{% endblock %}