{% extends "base_commerce.html" %}
{% load static %}
{% block title %}Statistiques des stocks de miel{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'commerce/css/list.css' %}">
<link rel="stylesheet" href="{% static 'commerce/css/stat.css' %}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<div class="liste-content">
    <h2 style="font-size:1.3em;margin-bottom:0.5em;">Statistiques des stocks de miel</h2>
    <div id="main-flex-container">
        <div id="sidecard-list" class="small-card">
            <h4 style="text-align:center;font-size:1em;margin:0 0 0.6em 0;">Types de miel</h4>
            <ul>
                {% for miel in stats %}
                <li data-miel-idx="{{ forloop.counter0 }}"{% if forloop.first %} class="selected"{% endif %}>
                    {{ miel.type }}
                </li>
                {% endfor %}
            </ul>
        </div>
        <div id="stats-panel">
            <div class="stat-cards-container">
                <div id="miel-stats" class="small-card"></div>
                <div class="stat-graphs-row">
                    <div class="small-card stat-graph-card">
                        <canvas id="curveChart" width="430" height="230"></canvas>
                    </div>
                    <div class="small-card stat-graph-card">
                        <canvas id="pieChart" width="260" height="230"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
const mielsStats = [
    {% for miel in stats %}
    {
        type: "{{ miel.type }}",
        stock_actuel: {{ miel.stock_actuel }},
        stock_initial: {{ miel.stock_initial }},
        total_entrees: {{ miel.total_entrees }},
        nb_entrees: {{ miel.nb_entrees }},
        total_sorties: {{ miel.total_sorties }},
        nb_sorties: {{ miel.nb_sorties }},
        valeur_stock: {{ miel.valeur_stock }},
        prix_unitaire: {{ miel.prix_unitaire }},
        evolution_stock: {{ miel.evolution_stock|safe }},
        evolution_dates: {{ miel.evolution_dates|safe }}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function renderStats(idx){
    const miel = mielsStats[idx];
    document.getElementById("miel-stats").innerHTML = `
        <table class="stat-table">
            <tr><th>Type</th><td>${miel.type}</td></tr>
            <tr><th>Stock initial</th><td>${miel.stock_initial}</td></tr>
            <tr><th>Stock actuel</th><td>${miel.stock_actuel}</td></tr>
            <tr><th>Prix unitaire (Ar)</th><td>${miel.prix_unitaire}</td></tr>
            <tr><th>Valeur stock (Ar)</th><td>${miel.valeur_stock}</td></tr>
            <tr><th>Total entrées</th><td>${miel.total_entrees}</td></tr>
            <tr><th>Nombre d’entrées</th><td>${miel.nb_entrees}</td></tr>
            <tr><th>Total sorties</th><td>${miel.total_sorties}</td></tr>
            <tr><th>Nombre de sorties</th><td>${miel.nb_sorties}</td></tr>
        </table>
    `;
}

let curveChart, pieChart;
function renderCharts(idx){
    const miel = mielsStats[idx];
    // Courbe évolution stock
    const cc = document.getElementById('curveChart').getContext('2d');
    if(curveChart) curveChart.destroy();
    curveChart = new Chart(cc, {
        type: 'line',
        data: {
            labels: miel.evolution_dates,
            datasets: [{
                label: 'Stock (unité)',
                data: miel.evolution_stock,
                fill: true,
                borderColor: '#9c7e42',
                backgroundColor: 'rgba(201,167,77,0.12)',
                tension: 0.25,
                pointBackgroundColor: '#f6ca7a',
                pointRadius: 3
            }]
        },
        options: {
            plugins: {legend: {display: false}},
            scales: {
                x: {
                    ticks: {font: {size: 12}, color: "#694b18"}
                },
                y: {
                    beginAtZero: true,
                    ticks: {font: {size: 12}, color: "#694b18"}
                }
            }
        }
    });
    // Camembert entrées/sorties
    const pc = document.getElementById('pieChart').getContext('2d');
    if(pieChart) pieChart.destroy();
    pieChart = new Chart(pc, {
        type: 'pie',
        data: {
            labels: ['Entrées', 'Sorties'],
            datasets: [{
                data: [miel.total_entrees, miel.total_sorties],
                backgroundColor: ['#62a469', '#d46a6a']
            }]
        },
        options: {plugins:{legend:{position:'bottom', labels: {font: {size:14}}}}}
    });
}

window.addEventListener("DOMContentLoaded", function(){
    const mielList = document.querySelectorAll('#sidecard-list li');
    let selected = 0;
    function selectMiel(idx){
        mielList.forEach((li,i) => li.classList.toggle('selected', i === idx));
        renderStats(idx);
        renderCharts(idx);
        selected = idx;
    }
    mielList.forEach((li,i)=>{
        li.addEventListener('click', ()=>selectMiel(i));
    });
    selectMiel(0);
});
</script>
{% endblock %}