{% extends "base_elevage.html" %}
{% load static %}

{% block title %}Alertes{% endblock %}
{% block page_title %}Alertes{% endblock %}

{% block content %}
<div class="elevage-content">
    <h2>Alertes et ruches à risque</h2>
    
    <div class="filters-container">
        <div class="filter-group">
            <label class="filter-label" for="niveau-filter">Niveau:</label>
            <select class="filter-select" id="niveau-filter">
                <option value="">Tous les niveaux</option>
                <option value="high">Critique</option>
                <option value="medium">Important</option>
                <option value="low">Information</option>
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label" for="type-filter">Type:</label>
            <select class="filter-select" id="type-filter">
                <option value="">Tous les types</option>
                {% for type in types_alerte %}
                    <option value="{{ type }}">{{ type }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label class="filter-label" for="status-filter">Statut:</label>
            <select class="filter-select" id="status-filter">
                <option value="">Tous les statuts</option>
                <option value="En cours">En cours</option>
                <option value="Résolue">Résolue</option>
            </select>
        </div>
        <div class="filter-group">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="alerte-search" placeholder="Rechercher...">
            </div>
        </div>
    </div>
    
    <div class="elevage-card">
        {% for alerte in alertes %}
            <div class="alert-card {{ alerte.niveau }}" data-niveau="{{ alerte.niveau }}" data-type="{{ alerte.type }}" data-status="{{ alerte.status }}">
                <div class="alert-icon {{ alerte.niveau }}">
                    {% if alerte.niveau == 'high' %}
                        <i class="fas fa-exclamation-triangle"></i>
                    {% elif alerte.niveau == 'medium' %}
                        <i class="fas fa-exclamation-circle"></i>
                    {% else %}
                        <i class="fas fa-info-circle"></i>
                    {% endif %}
                </div>
                <div class="alert-content">
                    <div class="alert-title">
                        {{ alerte.type }} - 
                        {% for ruche in ruches %}
                            {% if ruche.id == alerte.ruche_id %}
                                Ruche {{ ruche.nom }}
                            {% endif %}
                        {% endfor %}
                    </div>
                    <div class="alert-message">{{ alerte.description }}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-secondary);">
                        <i class="fas fa-calendar-alt"></i> {{ alerte.date }} | 
                        <span class="tag {% if alerte.status == 'En cours' %}tag-warning{% else %}tag-success{% endif %}" style="font-size: 0.7rem;">
                            {{ alerte.status }}
                        </span>
                    </div>
                </div>
                <div class="alert-actions">
                    {% if alerte.status == 'En cours' %}
                        <button class="btn btn-secondary resolve-alert" data-id="{{ alerte.id }}">
                            <i class="fas fa-check"></i> Résoudre
                        </button>
                    {% endif %}
                    <a href="{% url 'ruche_details' id=alerte.ruche_id %}" class="btn btn-secondary">
                        <i class="fas fa-eye"></i> Voir ruche
                    </a>
                </div>
            </div>
        {% empty %}
            <p class="text-center">Aucune alerte trouvée</p>
        {% endfor %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filtrage des alertes
        const niveauFilter = document.getElementById('niveau-filter');
        const typeFilter = document.getElementById('type-filter');
        const statusFilter = document.getElementById('status-filter');
        const searchInput = document.getElementById('alerte-search');
        const alerteCards = document.querySelectorAll('.alert-card');
        
        function filterAlertes() {
            const niveauValue = niveauFilter.value;
            const typeValue = typeFilter.value;
            const statusValue = statusFilter.value;
            const searchValue = searchInput.value.toLowerCase();
            
            alerteCards.forEach(card => {
                const niveau = card.getAttribute('data-niveau');
                const type = card.getAttribute('data-type');
                const status = card.getAttribute('data-status');
                const text = card.textContent.toLowerCase();
                
                const matchesNiveau = !niveauValue || niveau === niveauValue;
                const matchesType = !typeValue || type === typeValue;
                const matchesStatus = !statusValue || status === statusValue;
                const matchesSearch = !searchValue || text.includes(searchValue);
                
                if (matchesNiveau && matchesType && matchesStatus && matchesSearch) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        niveauFilter.addEventListener('change', filterAlertes);
        typeFilter.addEventListener('change', filterAlertes);
        statusFilter.addEventListener('change', filterAlertes);
        searchInput.addEventListener('input', filterAlertes);
        
        // Gestion des boutons "Résoudre"
        const resolveButtons = document.querySelectorAll('.resolve-alert');
        resolveButtons.forEach(button => {
            button.addEventListener('click', function() {
                const alerteId = this.getAttribute('data-id');
                
                // Dans une application réelle, cela enverrait une requête AJAX pour marquer l'alerte comme résolue
                if (confirm('Marquer cette alerte comme résolue ?')) {
                    // Simulation de la résolution - dans un cas réel, on ferait un appel AJAX ici
                    const card = this.closest('.alert-card');
                    card.setAttribute('data-status', 'Résolue');
                    
                    // Mettre à jour l'apparence
                    const statusTag = card.querySelector('.tag');
                    statusTag.textContent = 'Résolue';
                    statusTag.classList.remove('tag-warning');
                    statusTag.classList.add('tag-success');
                    
                    // Masquer le bouton résoudre
                    this.style.display = 'none';
                    
                    // Appliquer les filtres actuels
                    filterAlertes();
                }
            });
        });
    });
</script>
{% endblock %}
