{% extends "base_elevage.html" %}
{% load static %}

{% block title %}Statistiques de mortalité{% endblock %}
{% block page_title %}Statistiques de mortalité{% endblock %}

{% block extra_css %}
<style>
    .stat-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        flex: 1;
        min-width: 200px;
        padding: 1.25rem;
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--glass-border);
        text-align: center;
    }
    
    .stat-card h3 {
        font-size: 1.25rem;
        color: var(--honey-primary);
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
        background: var(--gradient-honey);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
    }
    
    .ruche-card {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
    }
    
    .ruche-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .ruche-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--honey-primary);
    }
    
    .mortalite-gauge {
        width: 100%;
        height: 12px;
        background-color: #e0e0e0;
        border-radius: 6px;
        overflow: hidden;
        margin: 0.5rem 0;
    }
    
    .mortalite-fill {
        height: 100%;
        border-radius: 6px;
    }
    
    .mortalite-critical {
        background-color: var(--queen-red);
    }
    
    .mortalite-warning {
        background-color: var(--honey-primary);
    }
    
    .mortalite-good {
        background-color: var(--pollen-green);
    }
</style>
{% endblock %}

{% block content %}
<div class="elevage-content">
    <h2>Statistiques de l'indice de dépopulation</h2>
    
    <div class="stat-summary">
        <div class="stat-card">
            <h3>Taux moyen</h3>
            <div class="stat-value" id="taux-moyen">-</div>
            <div class="stat-label">de mortalité</div>
        </div>
        
        <div class="stat-card">
            <h3>Ruches critiques</h3>
            <div class="stat-value" id="ruches-critiques">-</div>
            <div class="stat-label">Taux > 30%</div>
        </div>
        
        <div class="stat-card">
            <h3>Meilleure ruche</h3>
            <div class="stat-value" id="meilleure-ruche">-</div>
            <div class="stat-label">Plus faible taux de mortalité</div>
        </div>
        
        <div class="stat-card">
            <h3>Indice sanitaire</h3>
            <div class="stat-value" id="indice-sanitaire">-</div>
            <div class="stat-label">Santé globale du rucher</div>
        </div>
    </div>
    
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-chart-line"></i> Évolution de la mortalité
        </h3>
        
        <div class="chart-container">
            <canvas id="chart-evolution"></canvas>
        </div>
    </div>
    
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-chart-bar"></i> Taux de mortalité par ruche
        </h3>
        
        <div class="chart-container">
            <canvas id="chart-ruches"></canvas>
        </div>
    </div>
    
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-list"></i> Détail par ruche
        </h3>
        
        <div id="ruches-list">
            <!-- Liste des ruches générée par JavaScript -->
        </div>
    </div>
    
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-info-circle"></i> À propos de l'indice de dépopulation
        </h3>
        
        <p>L'indice de dépopulation représente le pourcentage estimé d'abeilles perdues dans chaque ruche sur une période donnée. Un taux supérieur à 30% est considéré comme critique et nécessite une intervention rapide pour déterminer la cause (maladies, parasites, intoxication...).</p>
        
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem;">
            <div style="flex: 1; min-width: 200px;">
                <h4 style="color: var(--honey-primary); margin-bottom: 0.5rem;">Causes principales de mortalité</h4>
                <ul style="padding-left: 1.5rem;">
                    <li>Varroa destructor</li>
                    <li>Pesticides et produits phytosanitaires</li>
                    <li>Maladies (loque, nosémose)</li>
                    <li>Stress environnemental</li>
                    <li>Conditions climatiques extrêmes</li>
                </ul>
            </div>
            
            <div style="flex: 1; min-width: 200px;">
                <h4 style="color: var(--honey-primary); margin-bottom: 0.5rem;">Actions recommandées</h4>
                <ul style="padding-left: 1.5rem;">
                    <li>Traitement anti-varroa régulier</li>
                    <li>Renouvellement des cires</li>
                    <li>Nourrissement adapté</li>
                    <li>Isolation en période hivernale</li>
                    <li>Surveillance régulière</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Récupérer les données
    const noms_ruches = {{ noms_ruches|safe }};
    const taux_mortalite = {{ taux_mortalite|safe }};
    const dates = {{ dates|safe }};
    const historique_mortalite = {{ historique_mortalite|safe }};
    
    // Calculer les statistiques
    const tauxMoyen = taux_mortalite.reduce((a, b) => a + b, 0) / taux_mortalite.length;
    const ruchesCritiques = taux_mortalite.filter(taux => taux > 30).length;
    const meilleurTaux = Math.min(...taux_mortalite);
    const meilleureRucheIndex = taux_mortalite.indexOf(meilleurTaux);
    const meilleureRucheNom = noms_ruches[meilleureRucheIndex];
    
    // Indice sanitaire (simulé) - inversement proportionnel au taux de mortalité moyen
    const indiceSanitaire = Math.max(1, Math.min(10, Math.round(10 - (tauxMoyen / 10))));
    
    // Mettre à jour les statistiques
    document.getElementById('taux-moyen').textContent = `${Math.round(tauxMoyen)}%`;
    document.getElementById('ruches-critiques').textContent = ruchesCritiques;
    document.getElementById('meilleure-ruche').textContent = `${meilleureRucheNom} (${meilleurTaux}%)`;
    document.getElementById('indice-sanitaire').textContent = `${indiceSanitaire}/10`;
    
    // Générer la liste des ruches
    const ruchesList = document.getElementById('ruches-list');
    noms_ruches.forEach((nom, index) => {
        const taux = taux_mortalite[index];
        let statusClass = 'mortalite-good';
        let statusText = 'Excellent';
        
        if (taux > 30) {
            statusClass = 'mortalite-critical';
            statusText = 'Critique';
        } else if (taux > 15) {
            statusClass = 'mortalite-warning';
            statusText = 'À surveiller';
        }
        
        const rucheCard = document.createElement('div');
        rucheCard.className = 'ruche-card';
        rucheCard.innerHTML = `
            <div class="ruche-header">
                <div class="ruche-title">${nom}</div>
                <div>
                    <span class="tag ${taux > 30 ? 'tag-danger' : taux > 15 ? 'tag-warning' : 'tag-success'}">
                        ${statusText}
                    </span>
                </div>
            </div>
            <div>
                <strong>Taux de mortalité:</strong> ${taux}%
                <div class="mortalite-gauge">
                    <div class="mortalite-fill ${statusClass}" style="width: ${taux}%"></div>
                </div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 0.75rem;">
                <span>
                    <i class="fas fa-calendar-alt"></i> Dernière mesure: Aujourd'hui
                </span>
                <a href="#" class="btn btn-secondary">
                    <i class="fas fa-eye"></i> Détails
                </a>
            </div>
        `;
        
        ruchesList.appendChild(rucheCard);
    });
    
    // Graphique d'évolution
    const evolutionCtx = document.getElementById('chart-evolution').getContext('2d');
    const evolutionChart = new Chart(evolutionCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: Object.keys(historique_mortalite).map((ruche, index) => {
                const colors = [
                    'rgba(255, 209, 0, 0.7)',
                    'rgba(0, 204, 136, 0.7)',
                    'rgba(0, 136, 255, 0.7)',
                    'rgba(255, 51, 102, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(54, 162, 235, 0.7)'
                ];
                
                return {
                    label: ruche,
                    data: historique_mortalite[ruche],
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length].replace('0.7', '0.1'),
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 5
                };
            })
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Taux de mortalité (%)'
                    }
                }
            }
        }
    });
    
    // Graphique par ruche
    const ruchesCtx = document.getElementById('chart-ruches').getContext('2d');
    const ruchesChart = new Chart(ruchesCtx, {
        type: 'bar',
        data: {
            labels: noms_ruches,
            datasets: [{
                label: 'Taux de mortalité (%)',
                data: taux_mortalite,
                backgroundColor: taux_mortalite.map(taux => {
                    if (taux > 30) return 'rgba(255, 51, 102, 0.7)';
                    if (taux > 15) return 'rgba(255, 209, 0, 0.7)';
                    return 'rgba(0, 204, 136, 0.7)';
                }),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 30,
                    title: {
                        display: true,
                        text: 'Taux de mortalité (%)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                }
            }
        }
    });
    
    // Configuration du graphique de mortalité mensuelle
    const monthlyMortalityCtx = document.getElementById('monthly-mortality-chart').getContext('2d');
    const monthlyMortalityChart = new Chart(monthlyMortalityCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Abeilles mortes par jour',
                data: mortaliteMensuelle,
                borderColor: '#FF3366',
                backgroundColor: 'rgba(255, 51, 102, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'abeilles'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                }
            }
        }
    });
    
    // Configuration du graphique des causes de mortalité
    const causesCtx = document.getElementById('causes-chart').getContext('2d');
    const causesChart = new Chart(causesCtx, {
        type: 'doughnut',
        data: {
            labels: causesLabels,
            datasets: [{
                data: causesData,
                backgroundColor: [
                    '#FFD100',
                    '#0088FF',
                    '#00CC88',
                    '#FF3366',
                    '#8A33FF'
                ],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed}%`;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
