{% extends "base_elevage.html" %}
{% load static %}

{% block title %}Statistiques de mortalité{% endblock %}
{% block page_title %}Statistiques de mortalité{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'elevage/css/elevage.css' %}">
<link rel="stylesheet" href="{% static 'elevage/css/dark-mode-fix.css' %}">
<style>
    .stat-summary {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stat-card {
        flex: 1;
        min-width: 200px;
        padding: 1.25rem;
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--glass-border);
        text-align: center;
        transition: all var(--transition-medium);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }
    
    .stat-card h3 {
        font-size: 1.25rem;
        color: var(--honey-primary);
        margin-bottom: 0.5rem;
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
        background: var(--gradient-honey);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }
    
    .stat-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    .chart-container {
        position: relative;
        height: 400px;
        margin-bottom: 1.5rem;
    }
    
    .ruche-card {
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        transition: all var(--transition-medium);
    }
    
    .ruche-card:hover {
        transform: translateX(5px);
        box-shadow: var(--shadow-md);
    }
    
    .ruche-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }
    
    .ruche-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--honey-primary);
    }
    
    .mortalite-gauge {
        width: 100%;
        height: 12px;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        overflow: hidden;
        margin: 0.5rem 0;
        position: relative;
    }
    
    .mortalite-fill {
        height: 100%;
        border-radius: 6px;
        transition: width 0.8s ease;
    }
    
    .mortalite-critical {
        background: linear-gradient(90deg, var(--queen-red), #FF6B6B);
    }
    
    .mortalite-warning {
        background: linear-gradient(90deg, var(--honey-primary), #FFE066);
    }
    
    .mortalite-good {
        background: linear-gradient(90deg, var(--pollen-green), #66CC88);
    }
    
    .mortalite-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    .causes-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .info-section {
        background: var(--glass-bg);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--glass-border);
    }
    
    .info-section h4 {
        color: var(--honey-primary);
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="elevage-content">
    <h2>Statistiques de l'indice de dépopulation</h2>
    
    <div class="stat-summary">
        <div class="stat-card">
            <h3>Taux moyen</h3>
            <div class="stat-value" id="taux-moyen">-</div>
            <div class="stat-label">de mortalité</div>
        </div>
        
        <div class="stat-card">
            <h3>Ruches critiques</h3>
            <div class="stat-value" id="ruches-critiques">-</div>
            <div class="stat-label">Taux > 30%</div>
        </div>
        
        <div class="stat-card">
            <h3>Meilleure ruche</h3>
            <div class="stat-value" id="meilleure-ruche">-</div>
            <div class="stat-label">Plus faible taux</div>
        </div>
        
        <div class="stat-card">
            <h3>Total décès</h3>
            <div class="stat-value" id="total-deces">-</div>
            <div class="stat-label">Abeilles enregistrées</div>
        </div>
    </div>
    
    <div class="causes-grid">
        <div class="elevage-card">
            <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
                <i class="fas fa-chart-line"></i> Évolution mensuelle
            </h3>
            <div class="chart-container">
                <canvas id="chart-evolution"></canvas>
            </div>
        </div>
        
        <div class="elevage-card">
            <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
                <i class="fas fa-chart-pie"></i> Causes estimées
            </h3>
            <div class="chart-container">
                <canvas id="causes-chart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-chart-bar"></i> Taux de mortalité par ruche
        </h3>
        <div class="chart-container">
            <canvas id="chart-ruches"></canvas>
        </div>
    </div>
    
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-snowflake"></i> Mortalité hivernale (6 dernières années)
        </h3>
        <div class="chart-container">
            <canvas id="winter-mortality-chart"></canvas>
        </div>
    </div>
    
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-list"></i> Détail par ruche
        </h3>
        <div id="ruches-list">
            <!-- Liste des ruches générée par JavaScript -->
        </div>
    </div>
    
    {% if mortalite_ruchers %}
    <div class="elevage-card">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-map-marker-alt"></i> Comparaison par rucher
        </h3>
        <div class="table-container">
            <table class="elevage-table">
                <thead>
                    <tr>
                        <th>Rucher</th>
                        <th>Taux annuel</th>
                        <th>Taux hivernal</th>
                        <th>Cause principale</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rucher in mortalite_ruchers %}
                    <tr>
                        <td>{{ rucher.nom }}</td>
                        <td>
                            <span class="tag {% if rucher.taux_annuel > 25 %}tag-danger{% elif rucher.taux_annuel > 15 %}tag-warning{% else %}tag-success{% endif %}">
                                {{ rucher.taux_annuel }}%
                            </span>
                        </td>
                        <td>{{ rucher.taux_hiver }}%</td>
                        <td>{{ rucher.principale_cause }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    <div class="info-section">
        <h3 style="color: var(--honey-primary); margin-bottom: 1rem;">
            <i class="fas fa-info-circle"></i> Informations sur la mortalité des abeilles
        </h3>
        
        <p style="margin-bottom: 1.5rem;">L'indice de dépopulation est calculé à partir des enregistrements réels de mortalité dans la base de données. Les causes listées sont des estimations basées sur les connaissances apicoles générales.</p>
        
        <div class="info-grid">
            <div>
                <h4>Causes principales de mortalité</h4>
                <ul style="padding-left: 1.5rem; line-height: 1.6;">
                    <li><strong>Varroa destructor</strong> - Principal parasite des abeilles</li>
                    <li><strong>Famine</strong> - Manque de nourriture en période critique</li>
                    <li><strong>Intoxication</strong> - Pesticides et produits chimiques</li>
                    <li><strong>Froid</strong> - Conditions climatiques extrêmes</li>
                    <li><strong>Autres</strong> - Maladies diverses et facteurs environnementaux</li>
                </ul>
            </div>
            
            <div>
                <h4>Actions recommandées</h4>
                <ul style="padding-left: 1.5rem; line-height: 1.6;">
                    <li><strong>Surveillance régulière</strong> - Inspections mensuelles</li>
                    <li><strong>Traitement préventif</strong> - Anti-varroa et nourrissement</li>
                    <li><strong>Isolation hivernale</strong> - Protection contre le froid</li>
                    <li><strong>Environnement sain</strong> - Éviter les zones polluées</li>
                    <li><strong>Enregistrement précis</strong> - Suivi des mortalités</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Récupérer les données du serveur
    const noms_ruches = {{ noms_ruches|safe }};
    const taux_mortalite = {{ taux_mortalite|safe }};
    const dates = {{ dates|safe }};
    const mortaliteMensuelle = {{ mortalite_mensuelle|safe }};
    const anneesHivernale = {{ annees_hivernale|safe }};
    const mortaliteHivernale = {{ mortalite_hivernale|safe }};
    const causesLabels = {{ causes_labels|safe }};
    const causesData = {{ causes_data|safe }};
    const ruchesData = {{ ruches_data|safe }};
    
    // Calculer les statistiques
    const tauxMoyen = taux_mortalite.length > 0 ? taux_mortalite.reduce((a, b) => a + b, 0) / taux_mortalite.length : 0;
    const ruchesCritiques = taux_mortalite.filter(taux => taux > 30).length;
    const meilleurTaux = taux_mortalite.length > 0 ? Math.min(...taux_mortalite) : 0;
    const meilleureRucheIndex = taux_mortalite.indexOf(meilleurTaux);
    const meilleureRucheNom = noms_ruches[meilleureRucheIndex] || 'Aucune';
    
    // Total des décès
    const totalDeces = ruchesData.reduce((sum, ruche) => sum + (ruche.total_deaths || 0), 0);
    
    // Mettre à jour les statistiques
    document.getElementById('taux-moyen').textContent = `${Math.round(tauxMoyen)}%`;
    document.getElementById('ruches-critiques').textContent = ruchesCritiques;
    document.getElementById('meilleure-ruche').textContent = meilleureRucheNom;
    document.getElementById('total-deces').textContent = totalDeces.toLocaleString();
    
    // Générer la liste des ruches
    const ruchesList = document.getElementById('ruches-list');
    ruchesData.forEach((ruche) => {
        const taux = ruche.taux_mortalite;
        let statusClass = 'mortalite-good';
        let statusText = 'Excellent';
        
        if (taux > 30) {
            statusClass = 'mortalite-critical';
            statusText = 'Critique';
        } else if (taux > 15) {
            statusClass = 'mortalite-warning';
            statusText = 'À surveiller';
        }
        
        const rucheCard = document.createElement('div');
        rucheCard.className = 'ruche-card';
        rucheCard.innerHTML = `
            <div class="ruche-header">
                <div class="ruche-title">${ruche.ruche_nom}</div>
                <div>
                    <span class="tag ${taux > 30 ? 'tag-danger' : taux > 15 ? 'tag-warning' : 'tag-success'}">
                        ${statusText}
                    </span>
                </div>
            </div>
            <div>
                <strong>Taux de mortalité:</strong> ${taux}%
                <div class="mortalite-gauge">
                    <div class="mortalite-fill ${statusClass}" style="width: ${Math.min(taux, 50)}%"></div>
                </div>
                <div class="mortalite-info">
                    <span>
                        <i class="fas fa-map-marker-alt"></i> ${ruche.localisation}
                    </span>
                    <span>
                        <i class="fas fa-skull"></i> ${ruche.total_deaths || 0} décès enregistrés
                    </span>
                </div>
            </div>
        `;
        
        ruchesList.appendChild(rucheCard);
    });
    
    // Configuration commune pour tous les graphiques
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                labels: {
                    color: 'var(--text-primary)',
                    font: {
                        family: "'Plus Jakarta Sans', sans-serif"
                    }
                }
            }
        },
        scales: {
            y: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)'
                },
                ticks: {
                    color: 'var(--text-secondary)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(255, 255, 255, 0.05)'
                },
                ticks: {
                    color: 'var(--text-secondary)'
                }
            }
        }
    };
    
    // Graphique d'évolution mensuelle
    const evolutionCtx = document.getElementById('chart-evolution').getContext('2d');
    new Chart(evolutionCtx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: [{
                label: 'Abeilles décédées',
                data: mortaliteMensuelle,
                borderColor: '#FF3366',
                backgroundColor: 'rgba(255, 51, 102, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#FF3366',
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Nombre d\'abeilles décédées'
                    }
                }
            }
        }
    });
    
    // Graphique des causes (estimées)
    const causesCtx = document.getElementById('causes-chart').getContext('2d');
    new Chart(causesCtx, {
        type: 'doughnut',
        data: {
            labels: causesLabels,
            datasets: [{
                data: causesData,
                backgroundColor: [
                    '#FFD100',
                    '#FF3366',
                    '#0088FF',
                    '#00CC88',
                    '#8A33FF'
                ],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 15,
                        color: 'var(--text-primary)'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: ${context.parsed}% (estimé)`;
                        }
                    }
                }
            }
        }
    });
    
    // Graphique par ruche
    const ruchesCtx = document.getElementById('chart-ruches').getContext('2d');
    new Chart(ruchesCtx, {
        type: 'bar',
        data: {
            labels: noms_ruches,
            datasets: [{
                label: 'Taux de mortalité (%)',
                data: taux_mortalite,
                backgroundColor: taux_mortalite.map(taux => {
                    if (taux > 30) return 'rgba(255, 51, 102, 0.8)';
                    if (taux > 15) return 'rgba(255, 209, 0, 0.8)';
                    return 'rgba(0, 204, 136, 0.8)';
                }),
                borderColor: taux_mortalite.map(taux => {
                    if (taux > 30) return '#FF3366';
                    if (taux > 15) return '#FFD100';
                    return '#00CC88';
                }),
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                legend: {
                    display: false
                }
            },
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    beginAtZero: true,
                    max: 50,
                    title: {
                        display: true,
                        text: 'Taux de mortalité (%)'
                    }
                }
            }
        }
    });
    
    // Graphique de mortalité hivernale
    const winterCtx = document.getElementById('winter-mortality-chart').getContext('2d');
    new Chart(winterCtx, {
        type: 'bar',
        data: {
            labels: anneesHivernale,
            datasets: [{
                label: 'Mortalité hivernale (%)',
                data: mortaliteHivernale,
                backgroundColor: 'rgba(0, 136, 255, 0.7)',
                borderColor: '#0088FF',
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            ...commonOptions,
            plugins: {
                ...commonOptions.plugins,
                legend: {
                    display: false
                }
            },
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    beginAtZero: true,
                    max: 30,
                    title: {
                        display: true,
                        text: 'Taux de mortalité hivernale (%)'
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
